import { NextRequest, NextResponse } from 'next/server';
import Database from 'better-sqlite3';
import path from 'path';
import fs from 'fs';
import { writeFile } from 'fs/promises';

// íŒŒì¼ ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (ë™ì  importë¡œ ë³€ê²½)
// import * as XLSX from 'xlsx';
// import * as mammoth from 'mammoth';
// import * as pdfParse from 'pdf-parse';

const dbPath = path.join(process.cwd(), 'database.db');

// íŒŒì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ í•¨ìˆ˜
async function extractTextFromFile(filePath: string, fileType: string, projectName: string = 'í”„ë¡œì íŠ¸'): Promise<{ text: string, imageAnalysis: string }> {
  try {
    console.log('íŒŒì¼ ì½ê¸° ì‹œì‘:', filePath);
    const fileContent = await fs.promises.readFile(filePath);
    console.log('íŒŒì¼ ì½ê¸° ì™„ë£Œ, í¬ê¸°:', fileContent.length);

    // íŒŒì¼ í™•ì¥ìì— ë”°ë¥¸ ì²˜ë¦¬
    const ext = path.extname(filePath).toLowerCase();
    console.log('íŒŒì¼ í™•ì¥ì:', ext);

    switch (ext) {
      case '.txt':
        console.log('TXT íŒŒì¼ ì²˜ë¦¬');
        return { text: fileContent.toString('utf-8'), imageAnalysis: '' };

      case '.csv':
        console.log('CSV íŒŒì¼ ì²˜ë¦¬');
        return { text: fileContent.toString('utf-8'), imageAnalysis: '' };

      case '.pdf':
        console.log('PDF íŒŒì¼ ì²˜ë¦¬');
        try {
          console.log('Starting PDF parsing, file size:', fileContent.length);

          // ì§ì ‘ pdf-parse ì‚¬ìš© (ë‹¨ìˆœí•˜ê³  í™•ì‹¤í•œ ë°©ë²•)
          console.log('PDF íŒŒì‹± ì‹œì‘ - ì§ì ‘ ë°©ì‹');
          console.log('fileContent íƒ€ì…:', typeof fileContent);
          console.log('fileContent Buffer ì—¬ë¶€:', Buffer.isBuffer(fileContent));
          console.log('fileContent ê¸¸ì´:', fileContent.length);

          // Node.js í™˜ê²½ì—ì„œ ì§ì ‘ ì‹¤í–‰ (í„°ë¯¸ë„ í…ŒìŠ¤íŠ¸ì—ì„œ ì„±ê³µí•œ ë°©ì‹)
          let pdfParse;

          try {
            // CommonJS require ì§ì ‘ ì‚¬ìš©
            pdfParse = eval('require')('pdf-parse');
            console.log('pdf-parse ë¡œë“œ ì„±ê³µ');
          } catch (loadError) {
            console.log('pdf-parse ë¡œë“œ ì‹¤íŒ¨:', loadError.message);
            throw new Error(`PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${loadError.message}`);
          }

          // PDF íŒŒì‹± ì‹¤í–‰
          const pdfResult = await pdfParse(fileContent);
          console.log('PDF íŒŒì‹± ì„±ê³µ!');
          console.log('í˜ì´ì§€ ìˆ˜:', pdfResult.numpages);
          console.log('ì›ë³¸ í…ìŠ¤íŠ¸ ê¸¸ì´:', pdfResult.text.length);

          // í…ìŠ¤íŠ¸ ë¶„ì„ ë° ë””ë²„ê¹…
          console.log('ğŸ” PDF í…ìŠ¤íŠ¸ ìƒì„¸ ë¶„ì„:');
          console.log('- ì›ë³¸ í…ìŠ¤íŠ¸ íƒ€ì…:', typeof pdfResult.text);
          console.log('- ì›ë³¸ í…ìŠ¤íŠ¸ ê¸¸ì´:', pdfResult.text.length);
          console.log('- ì›ë³¸ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° (ì²« 200ì):', JSON.stringify(pdfResult.text.substring(0, 200)));

          // í…ìŠ¤íŠ¸ ì •ë¦¬
          let text = pdfResult.text.trim();
          console.log('- trim() í›„ ê¸¸ì´:', text.length);

          // trim()ìœ¼ë¡œ í…ìŠ¤íŠ¸ê°€ ì‚¬ë¼ì¡Œë‹¤ë©´ ì›ë³¸ ì‚¬ìš©
          if (text.length === 0 && pdfResult.text.length > 0) {
            console.log('âš ï¸ trim()ìœ¼ë¡œ í…ìŠ¤íŠ¸ê°€ ì‚¬ë¼ì§, ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©');
            text = pdfResult.text;

            // ê³µë°± ë¬¸ìë“¤ì„ ì¼ë°˜ ê³µë°±ìœ¼ë¡œ ë³€í™˜
            text = text.replace(/[\s\u00A0\u2000-\u200F\u2028-\u202F\u3000]/g, ' ');
            text = text.replace(/\s+/g, ' ').trim();
            console.log('- ê³µë°± ì •ë¦¬ í›„ ê¸¸ì´:', text.length);
          }

          // í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ
          if (text.length > 20000) {
            text = text.substring(0, 20000) + "\n\n... (ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ì„œ ì•ë¶€ë¶„ë§Œ ì‚¬ìš©)";
            console.log('PDF í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ ì ìš©:', text.length);
          }

          console.log('PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì„±ê³µ, ìµœì¢… ê¸¸ì´:', text.length);
          console.log('PDF í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°:', text.substring(0, 200));

          // ìµœì¢… ê²€ì¦: í…ìŠ¤íŠ¸ê°€ ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ ì´ë¯¸ì§€ ì¶”ì¶œ ì‹œë„
          if (text.length === 0) {
            console.log('âš ï¸ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€ - ì´ë¯¸ì§€ ê¸°ë°˜ PDFë¡œ íŒë‹¨ë¨');
            console.log('ğŸ”„ PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ Vision AI ë¶„ì„ ì‹œë„...');

            try {
              // PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
              const path = eval('require')('path');
              const extractorPath = path.join(process.cwd(), 'src/lib/pdf-image-extractor-v2.js');

              // ëª¨ë“ˆ ì¡´ì¬ í™•ì¸
              const fs = eval('require')('fs');
              if (!fs.existsSync(extractorPath)) {
                console.warn('PDF ì´ë¯¸ì§€ ì¶”ì¶œê¸° ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', extractorPath);
                throw new Error('PDF ì´ë¯¸ì§€ ì¶”ì¶œ ëª¨ë“ˆ ì—†ìŒ');
              }

              const { extractImagesFromPDF } = eval('require')(extractorPath);
              const imageFiles = await extractImagesFromPDF(filePath, './temp/pdf-images-auto');

              if (imageFiles && imageFiles.length > 0) {
                console.log(`âœ… PDFì—ì„œ ${imageFiles.length}ê°œ ì´ë¯¸ì§€ ì¶”ì¶œ ì„±ê³µ`);

                // ì¶”ì¶œëœ ì´ë¯¸ì§€ë“¤ì„ Vision AIë¡œ ë¶„ì„
                const fs = eval('require')('fs');
                const imageAnalysisResults = [];

                for (const imagePath of imageFiles.slice(0, 5)) { // ìµœëŒ€ 5í˜ì´ì§€ê¹Œì§€
                  try {
                    console.log(`ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘: ${imagePath}`);

                    // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
                    const imageBuffer = fs.readFileSync(imagePath);
                    const base64Image = imageBuffer.toString('base64');

                    // Ollama Vision AIë¡œ ë¶„ì„
                    const visionPrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ë¬¸ì„œ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì´ ì´ë¯¸ì§€ëŠ” ${projectName} í”„ë¡œì íŠ¸ì˜ ê¸°ìˆ  ë¬¸ì„œì…ë‹ˆë‹¤.

**ì ˆëŒ€ì  ì§€ì‹œì‚¬í•­:**
- ì €ì‘ê¶Œ, ë¼ì´ì„ ìŠ¤, ëª…í™•í•˜ì§€ ì•Šë‹¤ëŠ” ë“±ì˜ ë³€ëª…ì€ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤
- ì´ë¯¸ì§€ì—ì„œ ë³´ì´ëŠ” ì‹¤ì œ í…ìŠ¤íŠ¸ì™€ ë‚´ìš©ì„ 100% ì •í™•íˆ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤
- ëª¨ë“  í•œê¸€ê³¼ ì˜ë¬¸ í…ìŠ¤íŠ¸ë¥¼ í•œ ê¸€ìë„ ë¹ ëœ¨ë¦¬ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ê¸°ë¡í•˜ì„¸ìš”

**í•„ìˆ˜ ë¶„ì„ í•­ëª©:**
1. **ì œëª©/í—¤ë”**: ë¬¸ì„œ ìƒë‹¨ì˜ ì œëª©, ë¡œê³ , í—¤ë” í…ìŠ¤íŠ¸
2. **ë©”ë‰´/ë²„íŠ¼**: ëª¨ë“  ë²„íŠ¼, ë©”ë‰´, ë§í¬ì˜ ì •í™•í•œ í…ìŠ¤íŠ¸
3. **ë³¸ë¬¸ ë‚´ìš©**: ë¬¸ì„œì˜ ëª¨ë“  ì„¤ëª…, ì§€ì‹œì‚¬í•­, ë‚´ìš©
4. **ì˜µì…˜/ì„¤ì •**: ì„¤ì • í•­ëª©, ì˜µì…˜, ì²´í¬ë°•ìŠ¤, ë“œë¡­ë‹¤ìš´ ë“±
5. **UI ìš”ì†Œ**: ì…ë ¥ í•„ë“œ, í…ìŠ¤íŠ¸ë°•ìŠ¤, ë¼ë²¨, ì•ˆë‚´ ë¬¸êµ¬
6. **ë‹¤ì´ì–´ê·¸ë¨**: í”Œë¡œìš°ì°¨íŠ¸, í™”ì‚´í‘œ, ì—°ê²°ì„ ì˜ ëª¨ë“  í…ìŠ¤íŠ¸
7. **ë‹¨ê³„/ì ˆì°¨**: ë²ˆí˜¸ê°€ ë§¤ê²¨ì§„ ë‹¨ê³„, ìˆœì„œ, í”„ë¡œì„¸ìŠ¤

**ì¶œë ¥ í˜•ì‹:**
ê° í•­ëª©ë³„ë¡œ ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ ë³´ì´ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì •í™•íˆ ê¸°ë¡í•˜ê³ , ${projectName} í”„ë¡œì íŠ¸ì˜ ê¸°ëŠ¥ê³¼ ì—°ê´€ì§€ì–´ ì„¤ëª…í•˜ì„¸ìš”.

ì§€ê¸ˆ ì¦‰ì‹œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìœ„ì˜ ëª¨ë“  í•­ëª©ì„ ë¹ ì§ì—†ì´ ì¶”ì¶œí•´ì£¼ì„¸ìš”.`;

                    const visionResponse = await fetch('http://localhost:11434/api/generate', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        model: 'llava:7b',
                        prompt: visionPrompt,
                        images: [base64Image],
                        stream: false
                      })
                    });

                    if (visionResponse.ok) {
                      const visionResult = await visionResponse.json();
                      if (visionResult.response) {
                        imageAnalysisResults.push(`[í˜ì´ì§€ ${imageAnalysisResults.length + 1}]\n${visionResult.response}`);
                        console.log(`âœ… í˜ì´ì§€ ${imageAnalysisResults.length} ë¶„ì„ ì™„ë£Œ`);
                      }
                    }
                  } catch (imageError) {
                    console.warn(`ì´ë¯¸ì§€ ë¶„ì„ ì‹¤íŒ¨: ${imagePath}`, imageError.message);
                  }
                }

                // ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
                if (imageAnalysisResults.length > 0) {
                  const combinedText = `
${projectName} í”„ë¡œì íŠ¸ ë¬¸ì„œ (ì´ë¯¸ì§€ ê¸°ë°˜ PDF ë¶„ì„ ê²°ê³¼)

${imageAnalysisResults.join('\n\n')}

ì°¸ê³ : ì´ ë‚´ìš©ì€ PDFì˜ ê° í˜ì´ì§€ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•œ í›„ Vision AIë¡œ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
                  `.trim();

                  console.log(`âœ… ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ: ${combinedText.length}ì ì¶”ì¶œ`);

                  // ì„ì‹œ ì´ë¯¸ì§€ íŒŒì¼ë“¤ ì •ë¦¬
                  try {
                    const path = eval('require')('path');
                    const tempDir = path.dirname(imageFiles[0]);
                    if (fs.existsSync(tempDir)) {
                      fs.rmSync(tempDir, { recursive: true, force: true });
                      console.log('ì„ì‹œ ì´ë¯¸ì§€ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ');
                    }
                  } catch (cleanupError) {
                    console.warn('ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì‹¤íŒ¨:', cleanupError.message);
                  }

                  return { text: combinedText, imageAnalysis: combinedAnalysis };
                }
              }
            } catch (imageExtractionError) {
              console.warn('PDF ì´ë¯¸ì§€ ì¶”ì¶œ ì‹¤íŒ¨:', imageExtractionError.message);
            }

            // ì´ë¯¸ì§€ ì¶”ì¶œë„ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒì„±
            console.log('ğŸ“ í”„ë¡œì íŠ¸ëª… ê¸°ë°˜ ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒì„±ìœ¼ë¡œ ëŒ€ì²´');

            // í”„ë¡œì íŠ¸ëª…ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
            const keywords = [];
            const projectLower = projectName.toLowerCase();

            // ì¼ë°˜ì ì¸ í‚¤ì›Œë“œ ë§¤í•‘
            if (projectLower.includes('ì›íˆ´') || projectLower.includes('tool')) {
              keywords.push('ë„êµ¬', 'íˆ´', 'ìœ í‹¸ë¦¬í‹°', 'ê¸°ëŠ¥');
            }
            if (projectLower.includes('ì˜µì…˜') || projectLower.includes('option')) {
              keywords.push('ì„¤ì •', 'ì˜µì…˜', 'êµ¬ì„±', 'ì„ íƒ');
            }
            if (projectLower.includes('ê¸°ëŠ¥') || projectLower.includes('function')) {
              keywords.push('ê¸°ëŠ¥', 'í•¨ìˆ˜', 'ëª¨ë“ˆ');
            }

            // ê¸°ë³¸ í”„ë¡œì íŠ¸ ê´€ë ¨ í…ìŠ¤íŠ¸ ìƒì„±
            const keywordText = keywords.length > 0 ?
              `\nì£¼ìš” í‚¤ì›Œë“œ: ${keywords.join(', ')}\n` : '';

            const projectBasedText = `
${projectName} í”„ë¡œì íŠ¸ ê¸°íšì„œ

ì´ ë¬¸ì„œëŠ” ${projectName} í”„ë¡œì íŠ¸ì˜ ê¸°ëŠ¥ ê°œë°œ ë° ê°œì„ ì‚¬í•­ì— ëŒ€í•œ ê¸°íšì„œì…ë‹ˆë‹¤.${keywordText}
ì£¼ìš” ê¸°ëŠ¥:
- ${projectName} ê´€ë ¨ ê¸°ëŠ¥ ê°œë°œ
- ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê°œì„ 
- ê¸°ëŠ¥ ì¶”ê°€ ë° ìˆ˜ì •
- ì„±ëŠ¥ ìµœì í™”
- ì‚¬ìš©ì„± í–¥ìƒ
- ì˜µì…˜ ì„¤ì • ê¸°ëŠ¥
- ë„êµ¬ ê´€ë¦¬ ê¸°ëŠ¥

í…ŒìŠ¤íŠ¸ ë²”ìœ„:
- ${projectName} í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- ì˜µì…˜ ì„¤ì • í…ŒìŠ¤íŠ¸
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
- ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
- ê¸°ë³¸ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
- ì˜µì…˜ ë³€ê²½ ì‹œ ë™ì‘ í™•ì¸
- ì˜¤ë¥˜ ìƒí™© ì²˜ë¦¬ í™•ì¸
- ì‚¬ìš©ì ê²½í—˜ ê°œì„  í™•ì¸

ì°¸ê³ : ì›ë³¸ PDFëŠ” ì´ë¯¸ì§€ë¡œë§Œ êµ¬ì„±ë˜ì–´ ìˆì–´ í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. 
ì´ë¯¸ì§€ ë¶„ì„ë„ ì‹¤íŒ¨í•˜ì—¬ í”„ë¡œì íŠ¸ëª… "${projectName}"ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ì ì¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
ë” ì •í™•í•œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìœ„í•´ì„œëŠ” í…ìŠ¤íŠ¸ í˜•íƒœì˜ ë¬¸ì„œë¥¼ ì œê³µí•˜ê±°ë‚˜, 
ë¬¸ì„œ ë‚´ìš©ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.
            `.trim();

            console.log('ğŸ“ í”„ë¡œì íŠ¸ëª… ê¸°ë°˜ ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒì„±:', projectBasedText.length, 'ì');
            return { text: projectBasedText, imageAnalysis: '' };
          }

          return { text: text, imageAnalysis: '' };
        } catch (pdfError) {
          console.error('PDF ì²˜ë¦¬ ì˜¤ë¥˜:', pdfError);
          console.error('ì˜¤ë¥˜ ìƒì„¸:', pdfError.message);
          console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', pdfError.stack);

          // PDF íŒŒì‹± ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ì˜¤ë¥˜ ë°œìƒ - AIê°€ ì¶”ì¸¡í•˜ì§€ ëª»í•˜ë„ë¡ í•¨
          throw new Error(`PDF íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì œ ë¬¸ì„œ ë‚´ìš©ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ì–´ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${pdfError.message}`);
        }

      case '.docx':
      case '.doc':
        console.log('Word íŒŒì¼ ì²˜ë¦¬');
        try {
          const mammoth = await import('mammoth');
          const mammothResult = await mammoth.extractRawText({ path: filePath });
          return { text: mammothResult.value, imageAnalysis: '' };
        } catch (wordError) {
          console.error('Word íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', wordError);
          return { text: "Word ë¬¸ì„œ ë‚´ìš© (ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ)", imageAnalysis: '' };
        }

      case '.xlsx':
      case '.xls':
        console.log('Excel íŒŒì¼ ì²˜ë¦¬');
        try {
          const XLSX = await import('xlsx');
          const workbook = XLSX.read(fileContent);
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          return { text: XLSX.utils.sheet_to_txt(worksheet), imageAnalysis: '' };
        } catch (excelError) {
          console.error('Excel íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', excelError);
          return { text: "Excel íŒŒì¼ ë‚´ìš© (ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ)", imageAnalysis: '' };
        }

      case '.pptx':
      case '.ppt':
        console.log('PowerPoint íŒŒì¼ ì²˜ë¦¬');
        return { text: "PowerPoint íŒŒì¼ ë‚´ìš© (PowerPoint ì§€ì›ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •)", imageAnalysis: '' };

      default:
        console.log('ê¸°ë³¸ í…ìŠ¤íŠ¸ ì²˜ë¦¬');
        return { text: fileContent.toString('utf-8'), imageAnalysis: '' };
    }
  } catch (error) {
    console.error('íŒŒì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜:', error);
    throw new Error(`íŒŒì¼ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
  }
}

// Ollama Visionì„ ì‚¬ìš©í•œ ì´ë¯¸ì§€ ë¶„ì„ í•¨ìˆ˜
async function analyzeImagesWithVision(imageFiles: File[]): Promise<string> {
  if (imageFiles.length === 0) {
    return '';
  }

  try {
    console.log(`${imageFiles.length}ê°œ ì´ë¯¸ì§€ ë¶„ì„ ì‹œì‘`);

    // ì´ë¯¸ì§€ íŒŒì¼ í•„í„°ë§ (PDF, ë¬¸ì„œ íŒŒì¼ ì œì™¸)
    const validImageTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp', 'image/bmp'];
    const validImages = imageFiles.filter(file => {
      const isValidImage = validImageTypes.includes(file.type);
      if (!isValidImage) {
        console.warn(`âš ï¸ ì´ë¯¸ì§€ê°€ ì•„ë‹Œ íŒŒì¼ ì œì™¸: ${file.name} (${file.type})`);
      }
      return isValidImage;
    });

    if (validImages.length === 0) {
      console.log('ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŒ');
      return '';
    }

    console.log(`${validImages.length}ê°œì˜ ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ ë°œê²¬`);

    let imageAnalysis = '\n\n=== ë‹¤ì´ì–´ê·¸ë¨/ì°¨íŠ¸ ë¶„ì„ (Ollama Vision) ===\n';

    for (let i = 0; i < validImages.length; i++) {
      const file = validImages[i];
      console.log(`ì´ë¯¸ì§€ ${i + 1} ë¶„ì„ ì¤‘: ${file.name}`);

      try {
        // íŒŒì¼ì„ Bufferë¡œ ë³€í™˜
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        const base64Image = fileBuffer.toString('base64');

        // Ollama Vision API í˜¸ì¶œ
        const response = await fetch('http://localhost:11434/api/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'llava:7b',
            prompt: `ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í•œêµ­ì–´ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”:
1. ì´ë¯¸ì§€ì— í¬í•¨ëœ í…ìŠ¤íŠ¸ë‚˜ ë¼ë²¨ë“¤
2. ë‹¤ì´ì–´ê·¸ë¨ì´ë‚˜ ì°¨íŠ¸ì˜ êµ¬ì¡° (ë°•ìŠ¤, í™”ì‚´í‘œ, ì—°ê²° ê´€ê³„)
3. í”„ë¡œì„¸ìŠ¤ íë¦„ì´ë‚˜ ë‹¨ê³„
4. ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œë‚˜ ê¸°ëŠ¥ë“¤
5. í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ê¸°ëŠ¥ì´ë‚˜ ì‹œë‚˜ë¦¬ì˜¤

ê°„ê²°í•˜ê³  ì •í™•í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”.`,
            images: [base64Image],
            stream: false,
            options: {
              temperature: 0.3,
              num_ctx: 2048
            }
          }),
        });

        if (!response.ok) {
          throw new Error(`Ollama Vision API ì˜¤ë¥˜: ${response.status}`);
        }

        const result = await response.json();

        if (result.response) {
          imageAnalysis += `\nì´ë¯¸ì§€ ${i + 1} (${file.name}):\n`;
          imageAnalysis += `íŒŒì¼ ì •ë³´: ${file.type}, ${Math.round(file.size / 1024)}KB\n`;
          imageAnalysis += `ë¶„ì„ ê²°ê³¼:\n${result.response}\n`;
          console.log(`ì´ë¯¸ì§€ ${i + 1} ë¶„ì„ ì™„ë£Œ`);
        } else {
          console.warn(`ì´ë¯¸ì§€ ${i + 1} ë¶„ì„ ê²°ê³¼ ì—†ìŒ`);
          imageAnalysis += `\nì´ë¯¸ì§€ ${i + 1} (${file.name}): ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n`;
        }

      } catch (imageError) {
        console.error(`ì´ë¯¸ì§€ ${i + 1} ë¶„ì„ ì‹¤íŒ¨:`, imageError);
        imageAnalysis += `\nì´ë¯¸ì§€ ${i + 1} (${file.name}): ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n`;
      }

      // ì´ë¯¸ì§€ ê°„ ê°„ê²©
      if (i < validImages.length - 1) {
        imageAnalysis += '\n---\n';
      }
    }

    console.log('ì „ì²´ ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ');
    return imageAnalysis;

  } catch (error) {
    console.error('ì´ë¯¸ì§€ ë¶„ì„ ì˜¤ë¥˜:', error);
    return '\n\n=== ì´ë¯¸ì§€ ë¶„ì„ ì‹¤íŒ¨ ===\nì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n';
  }
}

// AI í”„ë¡¬í”„íŠ¸ ìƒì„± (í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ ë¶„ì„ ê²°í•©)
function createAIPrompt(content: string, projectName: string, imageAnalysis: string = ''): string {
  // ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ë©´ ìš”ì•½ (ì œí•œì„ ëŠ˜ë ¤ì„œ ë” ë§ì€ ë‚´ìš© ì²˜ë¦¬)
  let processedContent = content;
  if (content.length > 15000) { // 10000 -> 15000ìœ¼ë¡œ ì¦ê°€
    processedContent = content.substring(0, 15000) + "\n\n... (ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ì„œ ì•ë¶€ë¶„ë§Œ ì‚¬ìš©)";
    console.log('í”„ë¡¬í”„íŠ¸ ë‚´ìš© ê¸¸ì´ ì œí•œ ì ìš©:', processedContent.length);
  }

  return `ë‹¹ì‹ ì€ ì „ë¬¸ QA ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. 

** ì¤‘ìš” ì§€ì‹œì‚¬í•­ **
- ì•„ë˜ ì œê³µëœ ë¬¸ì„œëŠ” "${projectName}" í”„ë¡œì íŠ¸ì˜ ì‹¤ì œ ê¸°íšì„œì…ë‹ˆë‹¤
- ë°˜ë“œì‹œ ì´ ë¬¸ì„œì˜ ì‹¤ì œ ë‚´ìš©ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”
- ë¬¸ì„œì— ì—†ëŠ” ì¼ë°˜ì ì¸ ê¸°ëŠ¥(ë¹„ë°€ë²ˆí˜¸, ë¡œê·¸ì¸ ë“±)ì„ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”
- ${projectName} í”„ë¡œì íŠ¸ì™€ ê´€ë ¨ëœ êµ¬ì²´ì ì¸ ê¸°ëŠ¥ê³¼ ì˜µì…˜ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”

**ì¤‘ìš”: ë°˜ë“œì‹œ ì•„ë˜ ì œê³µëœ ì‹¤ì œ ë¬¸ì„œ ë‚´ìš©ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”. ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.**

**í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ í˜•ì‹:**
ê° í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ëŠ” ë‹¤ìŒ í•„ë“œë¥¼ í¬í•¨ (ëª¨ë“  ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ):
   - title: í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì œëª©
   - description: ìƒì„¸ ì„¤ëª…
- category: ì¹´í…Œê³ ë¦¬ (ê¸°ëŠ¥í…ŒìŠ¤íŠ¸, ì„±ëŠ¥í…ŒìŠ¤íŠ¸, ë³´ì•ˆí…ŒìŠ¤íŠ¸, ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤, í†µí•©í…ŒìŠ¤íŠ¸)
   - priority: ìš°ì„ ìˆœìœ„ (high, medium, low)
   - status: ìƒíƒœ (draft)
- preCondition: ì‚¬ì „ ì¡°ê±´
- testStep: í…ŒìŠ¤íŠ¸ ë‹¨ê³„ (ì¤„ë°”ê¿ˆì€ \\n ì‚¬ìš©)
   - expectedResult: ì˜ˆìƒ ê²°ê³¼
- testStrategy: í…ŒìŠ¤íŠ¸ ì „ëµ

30ê°œ ì´ìƒ ìƒì„±í•˜ë˜, ë°˜ë“œì‹œ ë¬¸ì„œ ë‚´ìš©ë§Œ ê¸°ë°˜ìœ¼ë¡œ í•˜ì„¸ìš”.${imageAnalysis.length > 0 ? '\nì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë‹¤ì´ì–´ê·¸ë¨ê³¼ ë¬¸ì„œ ë‚´ìš©ì„ ëª¨ë‘ í™œìš©í•˜ì—¬ ë” ìƒì„¸í•˜ê³  í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.' : ''}
JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.

**ì‹¤ì œ ë¬¸ì„œ ë‚´ìš©:**
${processedContent}${imageAnalysis}

**ì£¼ì˜ì‚¬í•­: ìœ„ ë¬¸ì„œ ë‚´ìš©ê³¼ ë‹¤ì´ì–´ê·¸ë¨ ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‘ ê¸°ë°˜ìœ¼ë¡œ JSON ë°°ì—´ í˜•ì‹ì˜ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë‚˜ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ëª¨ë“  í•„ë“œ ê°’ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**`;
}

// Ollama API í˜¸ì¶œ (ë¬´ë£Œ ë¡œì»¬ AI)
// thinking ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ JSON ìƒì„±í•˜ëŠ” í•¨ìˆ˜
async function generateJSONFromThinking(thinkingContent: string): Promise<string> {
  try {
    const simplePrompt = `ë‹¤ìŒ thinking ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ JSON ë°°ì—´ì„ ìƒì„±í•´ì£¼ì„¸ìš”. 
    ì˜¤ì§ JSON ë°°ì—´ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
    
    ê° í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ëŠ” ë‹¤ìŒ í•„ë“œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
    - title, description, category, priority, status, preCondition, testStep, expectedResult, testStrategy
    
    Thinking ë‚´ìš©: ${thinkingContent.substring(0, 2000)}`;

    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-oss:20b',
        prompt: simplePrompt,
        stream: false,
        options: {
          temperature: 0.1,
          num_ctx: 4096,
          seed: Math.floor(Math.random() * 1000000)
        }
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    return result.response || '[]';
  } catch (error) {
    console.error('generateJSONFromThinking ì˜¤ë¥˜:', error);
    return '[]';
  }
}

// thinking ë‚´ìš©ì„ ë¶„ì„í•´ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
function createTestCasesFromThinking(thinkingContent: string, projectName: string = 'í”„ë¡œì íŠ¸'): any[] {
  console.log('Analyzing thinking content for test case creation');
  console.log('Project name:', projectName);
  console.log('Content preview:', thinkingContent.substring(0, 300));

  const testCases = [];

  // ë¬¸ì„œ ë‚´ìš©ì—ì„œ ì‹¤ì œ í‚¤ì›Œë“œ ì¶”ì¶œ
  const contentLower = thinkingContent.toLowerCase();

  // í”„ë¡œì íŠ¸ë³„ ë™ì  í‚¤ì›Œë“œ ìƒì„±
  let scenarios = [];

  // ì›íˆ´ í”„ë¡œì íŠ¸ ê´€ë ¨ í‚¤ì›Œë“œ
  if (projectName.includes('ì›íˆ´') || contentLower.includes('ì›íˆ´')) {
    scenarios = [
      { keyword: 'ì›íˆ´', title: 'ì›íˆ´ ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì˜µì…˜', title: 'ì˜µì…˜ ì„¤ì • ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ê¸°ëŠ¥ ë³€ê²½', title: 'ê¸°ëŠ¥ ë³€ê²½ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì„¤ì •', title: 'ì„¤ì • ì €ì¥ ë° ì ìš© í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì‹œì‘', title: 'ì‹œì‘ ë²„íŠ¼ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ë°ì´í„°', title: 'ë°ì´í„° ì…ë ¥ ë° ì €ì¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ê²€ìƒ‰', title: 'ë°ì´í„° ê²€ìƒ‰ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì›Œí¬í”Œë¡œìš°', title: 'ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'UI', title: 'ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ë²„íŠ¼', title: 'ë²„íŠ¼ ë™ì‘ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ì…ë ¥', title: 'ì‚¬ìš©ì ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì €ì¥', title: 'ë°ì´í„° ì €ì¥ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ë¡œë“œ', title: 'ë°ì´í„° ë¡œë“œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì„±ëŠ¥', title: 'ì‹œìŠ¤í…œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ì„±ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì˜¤ë¥˜', title: 'ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'í†µí•©', title: 'ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸', category: 'í†µí•©í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì ‘ê·¼', title: 'ì ‘ê·¼ ê¶Œí•œ í…ŒìŠ¤íŠ¸', category: 'ë³´ì•ˆí…ŒìŠ¤íŠ¸' },
      { keyword: 'í™”ë©´', title: 'í™”ë©´ í‘œì‹œ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ë©”ë‰´', title: 'ë©”ë‰´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'í”„ë¡œì„¸ìŠ¤', title: 'í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' }
    ];
  } else {
    // ì¼ë°˜ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ (ë‹¤ë¥¸ í”„ë¡œì íŠ¸ìš©)
    scenarios = [
      { keyword: 'ê¸°ëŠ¥', title: 'ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ë²„íŠ¼', title: 'ë²„íŠ¼ ë™ì‘ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ì…ë ¥', title: 'ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì €ì¥', title: 'ë°ì´í„° ì €ì¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ê²€ìƒ‰', title: 'ê²€ìƒ‰ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'í™”ë©´', title: 'í™”ë©´ í‘œì‹œ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ë©”ë‰´', title: 'ë©”ë‰´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ì„¤ì •', title: 'ì„¤ì • ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ë°ì´í„°', title: 'ë°ì´í„° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì„±ëŠ¥', title: 'ì„±ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ì„±ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì˜¤ë¥˜', title: 'ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ë³´ì•ˆ', title: 'ë³´ì•ˆ í…ŒìŠ¤íŠ¸', category: 'ë³´ì•ˆí…ŒìŠ¤íŠ¸' },
      { keyword: 'í†µí•©', title: 'í†µí•© í…ŒìŠ¤íŠ¸', category: 'í†µí•©í…ŒìŠ¤íŠ¸' },
      { keyword: 'UI', title: 'UI í…ŒìŠ¤íŠ¸', category: 'ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤' },
      { keyword: 'ë¡œê·¸ì¸', title: 'ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' },
      { keyword: 'ì‚¬ìš©ì', title: 'ì‚¬ìš©ì ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸', category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸' }
    ];
  }

  let testId = 1;

  scenarios.forEach(scenario => {
    if (thinkingContent.toLowerCase().includes(scenario.keyword.toLowerCase())) {
      const testCase = {
        title: scenario.title,
        description: `${scenario.keyword} ê´€ë ¨ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.`,
        category: scenario.category,
        priority: scenario.keyword.includes('90ì¼') || scenario.keyword.includes('ì •ì±…') ? 'high' :
          scenario.keyword.includes('ì˜¤ë¥˜') || scenario.keyword.includes('í™•ì¸') ? 'medium' : 'medium',
        status: 'draft',
        preCondition: 'ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì´ë©°, ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ëœ ìƒíƒœ',
        testStep: `1. ${scenario.keyword} ê´€ë ¨ ê¸°ëŠ¥ì— ì ‘ê·¼\n2. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì…ë ¥\n3. ê²°ê³¼ í™•ì¸`,
        expectedResult: `${scenario.keyword} ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•¨`,
        testStrategy: 'ê¸°ëŠ¥ ê²€ì¦'
      };

      testCases.push(testCase);
      testId++;
    }
  });

  // ìµœì†Œ 15ê°œëŠ” ë³´ì¥ - í”„ë¡œì íŠ¸ ê´€ë ¨ ê¸°ë³¸ ì¼€ì´ìŠ¤ ìƒì„±
  while (testCases.length < 15) {
    const additionalCases = [];

    if (projectName.includes('ì›íˆ´')) {
      additionalCases.push(
        {
          title: 'ì›íˆ´ ê¸°ë³¸ ì‹¤í–‰ í…ŒìŠ¤íŠ¸',
          description: 'ì›íˆ´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ì‹¤í–‰ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.',
          category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
          priority: 'high',
          status: 'draft',
          preCondition: 'ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ìƒíƒœ',
          testStep: '1. ì›íˆ´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰\n2. ê¸°ë³¸ í™”ë©´ ë¡œë”© í™•ì¸\n3. ì£¼ìš” ë©”ë‰´ ì ‘ê·¼ í™•ì¸',
          expectedResult: 'ì›íˆ´ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ê¸°ë³¸ í™”ë©´ì´ í‘œì‹œë¨',
          testStrategy: 'ê¸°ëŠ¥ ê²€ì¦'
        },
        {
          title: 'ì˜µì…˜ ì„¤ì • ì €ì¥ í…ŒìŠ¤íŠ¸',
          description: 'ì‚¬ìš©ìê°€ ì„¤ì •í•œ ì˜µì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.',
          category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
          priority: 'medium',
          status: 'draft',
          preCondition: 'ì›íˆ´ì´ ì‹¤í–‰ë˜ê³  ì˜µì…˜ ì„¤ì • í™”ë©´ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ìƒíƒœ',
          testStep: '1. ì˜µì…˜ ì„¤ì • í™”ë©´ ì ‘ê·¼\n2. ì„¤ì • ê°’ ë³€ê²½\n3. ì €ì¥ ë²„íŠ¼ í´ë¦­\n4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ í›„ ì„¤ì • í™•ì¸',
          expectedResult: 'ë³€ê²½ëœ ì˜µì…˜ ì„¤ì •ì´ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ê³  ìœ ì§€ë¨',
          testStrategy: 'ê¸°ëŠ¥ ê²€ì¦'
        },
        {
          title: 'ê¸°ëŠ¥ ë³€ê²½ ì ìš© í…ŒìŠ¤íŠ¸',
          description: 'ê¸°ëŠ¥ ë³€ê²½ ì‚¬í•­ì´ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.',
          category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
          priority: 'high',
          status: 'draft',
          preCondition: 'ì›íˆ´ì´ ì‹¤í–‰ë˜ê³  ê¸°ëŠ¥ ë³€ê²½ì´ ê°€ëŠ¥í•œ ìƒíƒœ',
          testStep: '1. ê¸°ëŠ¥ ë³€ê²½ ë©”ë‰´ ì ‘ê·¼\n2. ë³€ê²½í•  ê¸°ëŠ¥ ì„ íƒ\n3. ë³€ê²½ ì ìš©\n4. ê²°ê³¼ í™•ì¸',
          expectedResult: 'ì„ íƒëœ ê¸°ëŠ¥ ë³€ê²½ì´ ì •ìƒì ìœ¼ë¡œ ì ìš©ë¨',
          testStrategy: 'ê¸°ëŠ¥ ê²€ì¦'
        }
      );
    } else {
      additionalCases.push(
        {
          title: `${projectName} ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸`,
          description: `${projectName} í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.`,
          category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
          priority: 'high',
          status: 'draft',
          preCondition: 'ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ',
          testStep: '1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰\n2. ê¸°ë³¸ ê¸°ëŠ¥ ì ‘ê·¼\n3. ë™ì‘ í™•ì¸',
          expectedResult: 'ê¸°ë³¸ ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•¨',
          testStrategy: 'ê¸°ëŠ¥ ê²€ì¦'
        }
      );
    }

    additionalCases.forEach(testCase => {
      if (testCases.length < 20) {
        testCases.push(testCase);
      }
    });

    break; // ë¬´í•œë£¨í”„ ë°©ì§€
  }

  console.log(`Generated ${testCases.length} test cases from thinking analysis`);
  return testCases;
}

async function callOllama(prompt: string): Promise<any[]> {
  try {
    console.log('Ollama API í˜¸ì¶œ ì‹œì‘...');

    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-oss:20b',
        prompt: prompt,
        stream: false,
        context: null, // ì»¨í…ìŠ¤íŠ¸ ëª…ì‹œì  ë¦¬ì…‹
        options: {
          temperature: 0.2, // ë” ì¼ê´€ì„± ìˆëŠ” ì‘ë‹µì„ ìœ„í•´ ë‚®ì¶¤
          top_p: 0.8,
          num_predict: 8000, // ë” ê¸´ ì‘ë‹µì„ ìœ„í•´ í† í° ìˆ˜ ì¦ê°€
          stop: ['```', '---', 'Note:', 'ì°¸ê³ :', 'ì„¤ëª…:', 'explanation:'], // JSON ì‘ë‹µë§Œ ë°›ê¸° ìœ„í•´ ì¤‘ë‹¨ í† í° ì„¤ì •
          repeat_penalty: 1.1, // ë°˜ë³µ ë°©ì§€
          seed: Math.floor(Math.random() * 1000000), // ì§„ì§œ ëœë¤ ì‹œë“œ
          num_ctx: 4096 // ì»¨í…ìŠ¤íŠ¸ í¬ê¸° ëª…ì‹œì  ì„¤ì •
        }
      }),
      signal: AbortSignal.timeout(240000) // 240ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¦ê°€
    });

    if (!response.ok) {
      throw new Error(`Ollama API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
    }

    const result = await response.json();
    console.log('Ollama ì‘ë‹µ:', result);

    // Update Ollama response handling
    if (!result.response || result.response.trim() === '') {
      console.log('Ollama response is empty, checking thinking field:', result.thinking ? 'exists' : 'does not exist');
      if (result.thinking) {
        console.log('Thinking content length:', result.thinking.length);
        console.log('Thinking preview:', result.thinking.substring(0, 500));

        // thinking í•„ë“œì—ì„œ JSON ë°°ì—´ ì¶”ì¶œ ì‹œë„ - ë” ê°•ë ¥í•œ íŒ¨í„´ ë§¤ì¹­
        const thinkingContent = result.thinking;

        // ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ JSON ì¶”ì¶œ ì‹œë„
        let jsonMatch = thinkingContent.match(/\[[\s\S]*?\]/g);
        if (!jsonMatch) {
          // ë°±í‹± ì•ˆì˜ JSON ì°¾ê¸°
          jsonMatch = thinkingContent.match(/```json\s*(\[[\s\S]*?\])\s*```/);
          if (jsonMatch) jsonMatch = [jsonMatch[1]];
        }
        if (!jsonMatch) {
          // ë‹¨ìˆœ ë°°ì—´ íŒ¨í„´
          jsonMatch = thinkingContent.match(/\[\s*\{[\s\S]*?\}\s*\]/);
          if (jsonMatch) jsonMatch = [jsonMatch[0]];
        }

        if (jsonMatch && jsonMatch[0]) {
          console.log('Found JSON in thinking, attempting to parse');
          console.log('Extracted JSON preview:', jsonMatch[0].substring(0, 200));
          result.response = jsonMatch[0];
        } else {
          console.log('No JSON found in thinking field, generating from thinking content');
          // thinking ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ AIì—ê²Œ ë‹¤ì‹œ JSON ìƒì„± ìš”ì²­
          // thinking ë‚´ìš©ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±
          const testCases = createTestCasesFromThinking(result.thinking, projectName);
          result.response = JSON.stringify(testCases);
          console.log('Created', testCases.length, 'test cases from thinking analysis');
        }
      }

      if (!result.response || result.response.trim() === '') {
        throw new Error('No response received from Ollama.');
      }
    }

    // JSON ì‘ë‹µ íŒŒì‹± ì‹œë„
    try {
      // ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
      let jsonText = result.response;

      console.log('ì›ë³¸ ì‘ë‹µ ê¸¸ì´:', jsonText.length);
      console.log('ì›ë³¸ ì‘ë‹µ ì‹œì‘:', jsonText.substring(0, 200) + '...');

      // JSON ë°°ì—´ì´ ì½”ë“œ ë¸”ë¡ ì•ˆì— ìˆëŠ” ê²½ìš° ì¶”ì¶œ
      const jsonMatch = jsonText.match(/```(?:json)?\s*(\[.*?\])\s*```/s);
      if (jsonMatch) {
        jsonText = jsonMatch[1];
        console.log('ì½”ë“œ ë¸”ë¡ì—ì„œ JSON ì¶”ì¶œ ì„±ê³µ');
      }

      // JSON ë°°ì—´ì´ ëŒ€ê´„í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ì°¾ê¸°
      const arrayMatch = jsonText.match(/\[[\s\S]*\]/);
      if (arrayMatch) {
        jsonText = arrayMatch[0];
        console.log('ëŒ€ê´„í˜¸ íŒ¨í„´ì—ì„œ JSON ì¶”ì¶œ ì„±ê³µ');
      }

      // ì´ìŠ¤ì¼€ì´í”„ëœ ë¬¸ìì—´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      jsonText = jsonText.replace(/\\"/g, '"');
      // ì œì–´ ë¬¸ì ì œê±° (ì¤„ë°”ê¿ˆì€ \nìœ¼ë¡œ ë³€í™˜)
      jsonText = jsonText.replace(/\\n/g, '\\n');
      // ê¸°íƒ€ ì œì–´ ë¬¸ì ì œê±°
      jsonText = jsonText.replace(/[\x00-\x1F\x7F]/g, '');

      // í•œêµ­ì–´ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°
      jsonText = jsonText.replace(/"/g, '"').replace(/"/g, '"');
      // ì˜ëª»ëœ ë”°ì˜´í‘œ íŒ¨í„´ ìˆ˜ì •
      jsonText = jsonText.replace(/"(\s*[^"]*?\s*)"/g, '"$1"');

      console.log('ìµœì¢… JSON í…ìŠ¤íŠ¸ ê¸¸ì´:', jsonText.length);
      console.log('ìµœì¢… JSON í…ìŠ¤íŠ¸ ì‹œì‘:', jsonText.substring(0, 300) + '...');

      let testCases;
      try {
        testCases = JSON.parse(jsonText);
      } catch (strictParseError) {
        console.log('ì—„ê²©í•œ JSON íŒŒì‹± ì‹¤íŒ¨, ìˆ˜ì • ì‹œë„:', strictParseError);
        console.log('ì˜¤ë¥˜ ìœ„ì¹˜ ì£¼ë³€ í…ìŠ¤íŠ¸:', jsonText.substring(Math.max(0, 9200), 9350));

        // ë” ê°•ë ¥í•œ JSON ìˆ˜ì • ë¡œì§
        try {
          let cleanedJson = jsonText
            // ë°±í‹± ì²˜ë¦¬
            .replace(/`/g, '"')
            // ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ
            .replace(/'/g, '"')
            // ì—°ì†ëœ ì¤„ë°”ê¿ˆ ì •ë¦¬
            .replace(/\n\s*\n/g, '\n')
            // ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
            .replace(/,(\s*[}\]])/g, '$1')
            // ë¬¸ìì—´ ë‚´ë¶€ì˜ ì˜ëª»ëœ ë”°ì˜´í‘œ ì²˜ë¦¬ (ë” ê°•ë ¥í•˜ê²Œ)
            .replace(/: "([^"]*)"([^"]*)"([^"]*)",/g, ': "$1\\"$2\\"$3",')
            // ì„¤ëª… í•„ë“œ ë‚´ì˜ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°
            .replace(/"description": "([^"]*)"([^"]*)"([^"]*)",/g, '"description": "$1\\"$2\\"$3",')
            // preCondition í•„ë“œ ë‚´ì˜ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°  
            .replace(/"preCondition": "([^"]*)"([^"]*)"([^"]*)",/g, '"preCondition": "$1\\"$2\\"$3",')
            // testStep í•„ë“œ ë‚´ì˜ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°
            .replace(/"testStep": "([^"]*)"([^"]*)"([^"]*)",/g, '"testStep": "$1\\"$2\\"$3",')
            // expectedResult í•„ë“œ ë‚´ì˜ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°
            .replace(/"expectedResult": "([^"]*)"([^"]*)"([^"]*)",/g, '"expectedResult": "$1\\"$2\\"$3",')
            // ì¼ë°˜ì ì¸ ë¬¸ìì—´ ê°’ì—ì„œ ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°
            .replace(/": "([^"]*)"([^"]*)"([^"]*)"([^"]*)/g, '": "$1\\"$2\\"$3\\"$4"')
            // ì œì–´ ë¬¸ì ì™„ì „ ì œê±°
            .replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');

          console.log('ì •ë¦¬ëœ JSON ê¸¸ì´:', cleanedJson.length);
          console.log('ì •ë¦¬ëœ JSON ì‹œì‘:', cleanedJson.substring(0, 300) + '...');

          testCases = JSON.parse(cleanedJson);
          console.log('ìˆ˜ì •ëœ JSON íŒŒì‹± ì„±ê³µ!');
        } catch (relaxedParseError) {
          console.log('ìˆ˜ì •ëœ JSON íŒŒì‹±ë„ ì‹¤íŒ¨:', relaxedParseError);

          // ë§ˆì§€ë§‰ ì‹œë„: ì •ê·œì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ
          console.log('ì •ê·œì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ ì‹œë„...');
          try {
            // ë” ê°•ë ¥í•œ ì •ê·œì‹ìœ¼ë¡œ ëª¨ë“  í•„ë“œ ì¶”ì¶œ
            const testCaseObjects = [];

            // JSON ê°ì²´ë“¤ì„ ê°œë³„ì ìœ¼ë¡œ ì¶”ì¶œ
            const objectRegex = /{[^{}]*(?:{[^{}]*}[^{}]*)*}/g;
            const objects = jsonText.match(objectRegex) || [];

            console.log(`ë°œê²¬ëœ JSON ê°ì²´ ìˆ˜: ${objects.length}`);

            for (const obj of objects) {
              try {
                // ê° í•„ë“œë¥¼ ê°œë³„ì ìœ¼ë¡œ ì¶”ì¶œ
                const title = obj.match(/"title":\s*"([^"]*)"/) || obj.match(/"title":\s*'([^']*)'/) || [];
                const description = obj.match(/"description":\s*"([^"]*)"/) || obj.match(/"description":\s*'([^']*)'/) || [];
                const category = obj.match(/"category":\s*"([^"]*)"/) || obj.match(/"category":\s*'([^']*)'/) || [];
                const priority = obj.match(/"priority":\s*"([^"]*)"/) || obj.match(/"priority":\s*'([^']*)'/) || [];
                const status = obj.match(/"status":\s*"([^"]*)"/) || obj.match(/"status":\s*'([^']*)'/) || [];
                const preCondition = obj.match(/"preCondition":\s*"([^"]*)"/) || obj.match(/"preCondition":\s*'([^']*)'/) || [];
                const testStep = obj.match(/"testStep":\s*"([^"]*)"/) || obj.match(/"testStep":\s*'([^']*)'/) || [];
                const expectedResult = obj.match(/"expectedResult":\s*"([^"]*)"/) || obj.match(/"expectedResult":\s*'([^']*)'/) || [];
                const testStrategy = obj.match(/"testStrategy":\s*"([^"]*)"/) || obj.match(/"testStrategy":\s*'([^']*)'/) || [];

                // ìµœì†Œí•œ titleì´ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                if (title[1]) {
                  testCaseObjects.push({
                    title: title[1] || 'ì œëª© ì—†ìŒ',
                    description: description[1] || 'ì„¤ëª… ì—†ìŒ',
                    category: category[1] || 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
                    priority: priority[1] || 'medium',
                    status: status[1] || 'draft',
                    preCondition: preCondition[1] || 'AI ìƒì„± ì¤‘ ëˆ„ë½ë¨',
                    testStep: testStep[1] ? testStep[1].replace(/\\n/g, '\n') : '1. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ê°€ ëˆ„ë½ë¨',
                    expectedResult: expectedResult[1] || 'ì˜ˆìƒ ê²°ê³¼ê°€ ëˆ„ë½ë¨',
                    testStrategy: testStrategy[1] || 'ê²€ì¦ ë°©ë²•ì´ ëˆ„ë½ë¨'
                  });
                }
              } catch (objError) {
                console.log('ê°œë³„ ê°ì²´ íŒŒì‹± ì‹¤íŒ¨:', objError);
                continue;
              }
            }

            if (testCaseObjects.length > 0) {
              console.log(`ì •ê·œì‹ìœ¼ë¡œ ${testCaseObjects.length}ê°œ ì™„ì „í•œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ ì„±ê³µ!`);
              return testCaseObjects;
            }
          } catch (regexError) {
            console.log('ì •ê·œì‹ ì¶”ì¶œë„ ì‹¤íŒ¨:', regexError);
          }

          throw strictParseError;
        }
      }
      if (Array.isArray(testCases) && testCases.length > 0) {
        console.log('JSON íŒŒì‹± ì„±ê³µ, í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', testCases.length);
        return testCases;
      } else {
        console.log('JSON íŒŒì‹± ì„±ê³µí–ˆì§€ë§Œ ë°°ì—´ì´ ë¹„ì–´ìˆìŒ');
      }
    } catch (parseError) {
      console.log('JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
      console.log('íŒŒì‹± ì‹œë„í•œ í…ìŠ¤íŠ¸:', typeof jsonText !== 'undefined' && jsonText ? jsonText.substring(0, 500) + '...' : 'í…ìŠ¤íŠ¸ ì—†ìŒ');
    }

    // JSON íŒŒì‹±ì´ ì‹¤íŒ¨í•œ ê²½ìš° í…ìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ
    const text = result.response;
    const extractedTestCases = extractTestCasesFromText(text);

    if (extractedTestCases.length === 0) {
      // í”„ë¡œì íŠ¸ ê¸°ë°˜ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ë°˜í™˜
      return createTestCasesFromThinking('', projectName);
    }

    return extractedTestCases;
  } catch (error) {
    console.error('Ollama API í˜¸ì¶œ ì˜¤ë¥˜:', error);

    // íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ì¸ ê²½ìš° ë” êµ¬ì²´ì ì¸ ë©”ì‹œì§€ ì œê³µ
    if (error instanceof Error && error.name === 'AbortError') {
      console.log('AI ì‘ë‹µ ì‹œê°„ ì´ˆê³¼, ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ë°˜í™˜');
      return createTestCasesFromThinking('AI ì‘ë‹µ ì‹œê°„ ì´ˆê³¼', projectName);
    }

    throw new Error(`AI ì„œë¹„ìŠ¤ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
  }
}

// í…ìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (ê°•í™”ëœ íŒŒì‹± ë¡œì§)
function extractTestCasesFromText(text: string): any[] {
  const testCases = [];

  console.log('í…ìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ ì‹œì‘');
  console.log('í…ìŠ¤íŠ¸ ê¸¸ì´:', text.length);

  // 1. JSON ê°ì²´ íŒ¨í„´ ì°¾ê¸° (ê°œë³„ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤)
  const jsonObjectPattern = /\{\s*"title"\s*:\s*"([^"]+)"\s*,\s*"description"\s*:\s*"([^"]+)"\s*,\s*"category"\s*:\s*"([^"]+)"\s*,\s*"priority"\s*:\s*"([^"]+)"\s*,\s*"status"\s*:\s*"([^"]+)"\s*,\s*"testStep"\s*:\s*"([^"]+)"\s*,\s*"expectedResult"\s*:\s*"([^"]+)"\s*\}/gi;

  // 2. í…Œì´ë¸” í˜•ì‹ íŒ¨í„´ ì°¾ê¸° (TC-ID, ê¸°ëŠ¥, ì‹œë‚˜ë¦¬ì˜¤, ì…ë ¥ê°’, ì˜ˆìƒ ê²°ê³¼, ê²€ì¦ í¬ì¸íŠ¸)
  const tablePattern = /\|\s*\*\*([A-Z0-9-]+)\*\*\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|/gi;

  // 3. ì¶”ê°€ íŒ¨í„´: ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í—¤ë” ë‹¤ìŒì˜ ë°ì´í„° í–‰ë“¤
  const markdownTablePattern = /\|\s*([A-Z0-9-]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|/gi;

  // 4. ê°„ë‹¨í•œ í…Œì´ë¸” í–‰ íŒ¨í„´
  const simpleTablePattern = /\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|/gi;

  // 5. ë²ˆí˜¸ê°€ ìˆëŠ” í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ íŒ¨í„´
  const numberedPattern = /(\d+)[\.\s]*([^:\n]+)[:\s]*([^\n]+)/gi;

  // 6. ì œëª© íŒ¨í„´
  const titlePattern = /([ê°€-í£a-zA-Z\s]+)(í…ŒìŠ¤íŠ¸|ê²€ì¦|í™•ì¸|ì‹œí—˜)/gi;

  // 7. ê¸°ëŠ¥ë³„ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ íŒ¨í„´
  const functionPattern = /([ê°€-í£a-zA-Z\s]+)(ê¸°ëŠ¥|ëª¨ë“ˆ|ì‹œìŠ¤í…œ)(.*?)(í…ŒìŠ¤íŠ¸|ê²€ì¦|í™•ì¸)/gi;

  let match;
  let count = 0;

  // JSON ê°ì²´ íŒ¨í„´ì—ì„œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ
  while ((match = jsonObjectPattern.exec(text)) && count < 50) {
    const title = match[1].trim();
    const description = match[2].trim();
    const category = match[3].trim();
    const priority = match[4].trim();
    const status = match[5].trim();
    const testStep = match[6].trim();
    const expectedResult = match[7].trim();

    console.log(`Found JSON object pattern match: ${title}`);

    testCases.push({
      title: title,
      description: description,
      category: category,
      testStep: testStep,
      expectedResult: expectedResult,
      priority: priority.toLowerCase(),
      status: status.toLowerCase()
    });
    count++;
  }

  // í…Œì´ë¸” í˜•ì‹ì—ì„œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì¶”ì¶œ
  while ((match = tablePattern.exec(text)) && count < 20) {
    const testCaseId = match[1].trim();
    const functionality = match[2].trim();
    const scenario = match[3].trim();
    const input = match[4].trim();
    const expectedResult = match[5].trim();
    const verificationPoint = match[6].trim();

    console.log(`Found table pattern match: ${testCaseId} - ${functionality}`);

    testCases.push({
      title: functionality,
      description: `ì‹œë‚˜ë¦¬ì˜¤: ${scenario}\nì…ë ¥ê°’: ${input}\nì˜ˆìƒ ê²°ê³¼: ${expectedResult}\nê²€ì¦ í¬ì¸íŠ¸: ${verificationPoint}`,
      category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
      testStep: scenario,
      expectedResult: expectedResult,
      priority: 'medium',
      status: 'draft'
    });
    count++;
  }

  // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” íŒ¨í„´ìœ¼ë¡œ ì¶”ê°€ ì¶”ì¶œ
  while ((match = markdownTablePattern.exec(text)) && count < 20) {
    const testCaseId = match[1].trim();
    const functionality = match[2].trim();
    const scenario = match[3].trim();
    const input = match[4].trim();
    const expectedResult = match[5].trim();
    const verificationPoint = match[6].trim();

    // ì´ë¯¸ ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì¸ì§€ í™•ì¸
    const existing = testCases.find(tc => tc.title === functionality);
    if (existing) continue;

    console.log(`Found markdown table pattern match: ${testCaseId} - ${functionality}`);

    testCases.push({
      title: functionality,
      description: `ì‹œë‚˜ë¦¬ì˜¤: ${scenario}\nì…ë ¥ê°’: ${input}\nì˜ˆìƒ ê²°ê³¼: ${expectedResult}\nê²€ì¦ í¬ì¸íŠ¸: ${verificationPoint}`,
      category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
      testStep: scenario,
      expectedResult: expectedResult,
      priority: 'medium',
      status: 'draft'
    });
    count++;
  }

  // 3. ê°„ë‹¨í•œ í…Œì´ë¸” í–‰ íŒ¨í„´ìœ¼ë¡œ ì¶”ê°€ ì¶”ì¶œ
  if (testCases.length < 5) {
    while ((match = simpleTablePattern.exec(text)) && count < 10) {
      const testCaseId = match[1].trim();
      const functionality = match[2].trim();
      const scenario = match[3].trim();
      const input = match[4].trim();
      const expectedResult = match[5].trim();
      const verificationPoint = match[6].trim();

      // ì´ë¯¸ ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì¸ì§€ í™•ì¸
      const existing = testCases.find(tc => tc.title === functionality);
      if (existing) continue;

      console.log(`Found simple table pattern match: ${testCaseId} - ${functionality}`);

      testCases.push({
        title: functionality,
        description: `ì‹œë‚˜ë¦¬ì˜¤: ${scenario}\nì…ë ¥ê°’: ${input}\nì˜ˆìƒ ê²°ê³¼: ${expectedResult}\nê²€ì¦ í¬ì¸íŠ¸: ${verificationPoint}`,
        category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
        testStep: scenario,
        expectedResult: expectedResult,
        priority: 'medium',
        status: 'draft'
      });
      count++;
    }
  }

  // 4. ë²ˆí˜¸ê°€ ìˆëŠ” í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ íŒ¨í„´
  if (testCases.length < 5) {
    while ((match = numberedPattern.exec(text)) && count < 10) {
      const number = match[1].trim();
      const title = match[2].trim();
      const description = match[3].trim();

      // ì´ë¯¸ ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì¸ì§€ í™•ì¸
      const existing = testCases.find(tc => tc.title === title);
      if (existing) continue;

      console.log(`Found numbered pattern match: ${number} - ${title}`);

      testCases.push({
        title: title,
        description: description,
        category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
        testStep: `1. ${title} ê¸°ëŠ¥ ì ‘ê·¼\n2. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\n3. ê²°ê³¼ í™•ì¸`,
        expectedResult: "ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•¨",
        priority: 'medium',
        status: 'draft'
      });
      count++;
    }
  }

  // 5. ì œëª© íŒ¨í„´ìœ¼ë¡œ ì¶”ê°€ ì¶”ì¶œ
  if (testCases.length < 5) {
    while ((match = titlePattern.exec(text)) && count < 10) {
      const title = match[1].trim() + match[2];

      // ì´ë¯¸ ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì¸ì§€ í™•ì¸
      const existing = testCases.find(tc => tc.title === title);
      if (existing) continue;

      console.log(`Found title pattern match: ${title}`);

      testCases.push({
        title: title,
        description: `${title}ì— ëŒ€í•œ ìƒì„¸ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤`,
        category: 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
        testStep: `1. ${title} ê¸°ëŠ¥ ì ‘ê·¼\n2. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\n3. ê²°ê³¼ í™•ì¸`,
        expectedResult: "ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•¨",
        priority: 'medium',
        status: 'draft'
      });
      count++;
    }
  }

  // 6. ê¸°ì¡´ Test Case íŒ¨í„´ë„ ì§€ì›
  if (testCases.length === 0) {
    const testCasePattern = /Test Case \d+[:\s]*([^\n]+)/gi;
    let testCaseMatch;

    while ((testCaseMatch = testCasePattern.exec(text)) && count < 10) {
      const title = testCaseMatch[1].trim();
      console.log(`í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ${count + 1}:`, title);

      testCases.push({
        title: title,
        description: `í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ${count + 1}ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…`,
        category: "ê¸°ë³¸",
        priority: "medium",
        status: "draft",
        preCondition: "í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì¤€ë¹„ë˜ì–´ ìˆì–´ì•¼ í•¨",
        testStep: `1. ${title} ê¸°ëŠ¥ ì ‘ê·¼\n2. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\n3. ê²°ê³¼ í™•ì¸`,
        expectedResult: "ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•¨"
      });
      count++;
    }
  }

  // ìµœì†Œ 3ê°œ ì´ìƒì˜ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ì—†ìœ¼ë©´ í”„ë¡œì íŠ¸ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¡œ ë³´ì¶©
  if (testCases.length < 3) {
    console.log(`í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ${testCases.length}ê°œë§Œ ì¶”ì¶œë¨, í”„ë¡œì íŠ¸ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¡œ ë³´ì¶©`);

    // í”„ë¡œì íŠ¸ ê¸°ë°˜ ê¸°ë³¸ ì¼€ì´ìŠ¤ ìƒì„±
    const additionalCases = createTestCasesFromThinking('í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ ë³´ì¶©', projectName);

    // ì¤‘ë³µ ì œê±°í•˜ë©° ì¶”ê°€
    additionalCases.forEach(additionalCase => {
      if (testCases.length < 10 && !testCases.some(tc => tc.title === additionalCase.title)) {
        testCases.push(additionalCase);
      }
    });
  }

  console.log('ì¶”ì¶œëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', testCases.length);
  return testCases;
}

// ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± í•¨ìˆ˜
function generateDefaultTestCases(projectName: string, content: string): any[] {
  console.log('ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± ì‹œì‘');

  // í”„ë¡œì íŠ¸ë³„ ë§ì¶¤ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±
  let testCases = [];

  if (projectName.includes('ì›íˆ´')) {
    testCases = [
      {
        title: "ì›íˆ´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ í…ŒìŠ¤íŠ¸",
        description: "ì›íˆ´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.",
        category: "ê¸°ëŠ¥í…ŒìŠ¤íŠ¸",
        priority: "high",
        status: "draft",
        preCondition: "ì‹œìŠ¤í…œì— ì›íˆ´ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨",
        testStep: "1. ì›íˆ´ ì‹¤í–‰ íŒŒì¼ í´ë¦­\n2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© í™•ì¸\n3. ë©”ì¸ í™”ë©´ í‘œì‹œ í™•ì¸",
        expectedResult: "ì›íˆ´ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ê³  ë©”ì¸ í™”ë©´ì´ í‘œì‹œë¨"
      },
      {
        title: "ì˜µì…˜ ì„¤ì • ë³€ê²½ í…ŒìŠ¤íŠ¸",
        description: "ì˜µì…˜ ì„¤ì • ë³€ê²½ ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.",
        category: "ê¸°ëŠ¥í…ŒìŠ¤íŠ¸",
        priority: "medium",
        status: "draft",
        preCondition: "ì›íˆ´ì´ ì‹¤í–‰ë˜ê³  ì˜µì…˜ ë©”ë‰´ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ìƒíƒœ",
        testStep: "1. ì˜µì…˜ ë©”ë‰´ ì ‘ê·¼\n2. ì„¤ì • í•­ëª© ë³€ê²½\n3. ì ìš© ë²„íŠ¼ í´ë¦­\n4. ë³€ê²½ ì‚¬í•­ í™•ì¸",
        expectedResult: "ì˜µì…˜ ì„¤ì •ì´ ì •ìƒì ìœ¼ë¡œ ë³€ê²½ë˜ê³  ì ìš©ë¨"
      },
      {
        title: "íšŒì›ê°€ì… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸",
        description: "ìƒˆë¡œìš´ ì‚¬ìš©ì íšŒì›ê°€ì… ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.",
        category: "íšŒì›ê°€ì…",
        priority: "high",
        status: "draft",
        preCondition: "íšŒì›ê°€ì… í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•¨",
        testStep: "1. íšŒì›ê°€ì… í˜ì´ì§€ ì ‘ì†\n2. í•„ìˆ˜ ì •ë³´ ì…ë ¥\n3. íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­",
        expectedResult: "íšŒì›ê°€ì…ì´ ì„±ê³µí•˜ê³  í™•ì¸ ì´ë©”ì¼ ë°œì†¡"
      },
      {
        title: "ìƒí’ˆ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸",
        description: "ìƒí’ˆ ëª©ë¡ì„ ì •ìƒì ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.",
        category: "ìƒí’ˆê´€ë¦¬",
        priority: "medium",
        status: "draft",
        preCondition: "ìƒí’ˆ ë°ì´í„°ê°€ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•¨",
        testStep: "1. ë©”ì¸ í˜ì´ì§€ ì ‘ì†\n2. ìƒí’ˆ ëª©ë¡ í™•ì¸\n3. ìƒí’ˆ ì •ë³´ ê²€ì¦",
        expectedResult: "ìƒí’ˆ ëª©ë¡ì´ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨"
      },
      {
        title: "ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ í…ŒìŠ¤íŠ¸",
        description: "ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.",
        category: "ì£¼ë¬¸ê´€ë¦¬",
        priority: "high",
        status: "draft",
        preCondition: "ë¡œê·¸ì¸ëœ ìƒíƒœì´ê³  ìƒí’ˆì´ ìˆì–´ì•¼ í•¨",
        testStep: "1. ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì ‘ì†\n2. ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ë²„íŠ¼ í´ë¦­\n3. ì¥ë°”êµ¬ë‹ˆ í™•ì¸",
        expectedResult: "ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì •ìƒì ìœ¼ë¡œ ì¶”ê°€ë¨"
      }
    ];

    console.log('ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± ì™„ë£Œ:', testCases.length);
    return testCases;
}

export async function POST(request: NextRequest) {
    try {
      console.log('AI í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± API í˜¸ì¶œ ì‹œì‘');

      const formData = await request.formData();
      const file = formData.get('file') as File;
      const projectId = formData.get('projectId') as string;
      const projectName = formData.get('projectName') as string;

      // ì¶”ê°€: ì´ë¯¸ì§€ íŒŒì¼ë“¤ (ë‹¤ì´ì–´ê·¸ë¨/ì°¨íŠ¸)
      const imageFiles = formData.getAll('images') as File[];

      // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
      const maxFileSize = 5 * 1024 * 1024; // 5MB
      const maxImageSize = 2 * 1024 * 1024; // 2MB per image

      if (file.size > maxFileSize) {
        return NextResponse.json({
          success: false,
          error: `PDF íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${Math.round(maxFileSize / 1024 / 1024)}MBê¹Œì§€ ì§€ì›ë©ë‹ˆë‹¤.`
        }, { status: 400 });
      }

      // ì´ë¯¸ì§€ íŒŒì¼ë“¤ í¬ê¸° ì²´í¬
      for (const imageFile of imageFiles) {
        if (imageFile.size > maxImageSize) {
          return NextResponse.json({
            success: false,
            error: `ì´ë¯¸ì§€ íŒŒì¼ "${imageFile.name}" í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ì´ë¯¸ì§€ë‹¹ ìµœëŒ€ ${Math.round(maxImageSize / 1024 / 1024)}MBê¹Œì§€ ì§€ì›ë©ë‹ˆë‹¤.`
          }, { status: 400 });
        }
      }

      // ì „ì²´ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì˜ ì´ í¬ê¸° ì²´í¬ (ìµœëŒ€ 5MB)
      const totalImageSize = imageFiles.reduce((total, file) => total + file.size, 0);
      const maxTotalImageSize = 5 * 1024 * 1024; // 5MB
      if (totalImageSize > maxTotalImageSize) {
        return NextResponse.json({
          success: false,
          error: `ì´ë¯¸ì§€ íŒŒì¼ë“¤ì˜ ì´ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ëª¨ë“  ì´ë¯¸ì§€ í•©ì³ì„œ ìµœëŒ€ ${Math.round(maxTotalImageSize / 1024 / 1024)}MBê¹Œì§€ ì§€ì›ë©ë‹ˆë‹¤.`
        }, { status: 400 });
      }

      console.log('ë°›ì€ ë°ì´í„°:', {
        fileName: file?.name,
        fileSize: file?.size,
        projectId,
        projectName
      });

      if (!file) {
        console.log('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•ŠìŒ');
        return NextResponse.json(
          { success: false, error: 'íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' },
          { status: 400 }
        );
      }

      if (!projectId) {
        console.log('í”„ë¡œì íŠ¸ IDê°€ ì—†ìŒ');
        return NextResponse.json(
          { success: false, error: 'í”„ë¡œì íŠ¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
          { status: 400 }
        );
      }

      // íŒŒì¼ ì €ì¥
      console.log('íŒŒì¼ ì €ì¥ ì‹œì‘');
      const bytes = await file.arrayBuffer();
      const buffer = Buffer.from(bytes);
      const uploadDir = path.join(process.cwd(), 'uploads');

      console.log('ì—…ë¡œë“œ ë””ë ‰í† ë¦¬:', uploadDir);

      // ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
      if (!fs.existsSync(uploadDir)) {
        console.log('ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±');
        fs.mkdirSync(uploadDir, { recursive: true });
      }

      const fileName = `${Date.now()}-${file.name}`;
      const filePath = path.join(uploadDir, fileName);
      console.log('íŒŒì¼ ì €ì¥ ê²½ë¡œ:', filePath);

      try {
        await writeFile(filePath, buffer);
        console.log('íŒŒì¼ ì €ì¥ ì™„ë£Œ');
      } catch (error) {
        console.error('íŒŒì¼ ì €ì¥ ì˜¤ë¥˜:', error);
        throw new Error('íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }

      // íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
      console.log('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘');
      let content: string;
      let imageAnalysis: string = '';

      try {
        const extractResult = await extractTextFromFile(filePath, file.type, projectName);
        content = extractResult.text;
        imageAnalysis = extractResult.imageAnalysis;
        console.log('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ, ê¸¸ì´:', content.length);
        console.log('ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ ê¸¸ì´:', imageAnalysis.length);

        // ì´ë¯¸ì§€ íŒŒì¼ë“¤ ë¶„ì„
        console.log('ì´ë¯¸ì§€ ë¶„ì„ ì‹œì‘');
        console.log('ì „ë‹¬ë°›ì€ ì´ë¯¸ì§€ íŒŒì¼ ìˆ˜:', imageFiles.length);
        if (imageFiles.length > 0) {
          console.log('ì´ë¯¸ì§€ íŒŒì¼ ì •ë³´:');
          imageFiles.forEach((file, index) => {
            console.log(`  ${index + 1}. ${file.name} (${file.type}, ${Math.round(file.size / 1024)}KB)`);
          });

          const additionalImageAnalysis = await analyzeImagesWithVision(imageFiles);
          if (additionalImageAnalysis.length > 0) {
            imageAnalysis = imageAnalysis.length > 0
              ? imageAnalysis + '\n\n=== ì¶”ê°€ ì´ë¯¸ì§€ ë¶„ì„ ===\n' + additionalImageAnalysis
              : additionalImageAnalysis;
          }
        }

        console.log('ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ');
        console.log('ìµœì¢… ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ ê¸¸ì´:', imageAnalysis.length);
        console.log('ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°:', imageAnalysis.substring(0, 500));
      } catch (error) {
        console.error('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜:', error);
        throw new Error('íŒŒì¼ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      // AI í”„ë¡¬í”„íŠ¸ ìƒì„±
      console.log('AI í”„ë¡¬í”„íŠ¸ ìƒì„±');
      console.log('ì¶”ì¶œëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì²« 500ì):', content.substring(0, 500));
      console.log('ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ ê¸¸ì´:', imageAnalysis.length);
      const prompt = createAIPrompt(content, projectName, imageAnalysis);
      console.log('í”„ë¡¬í”„íŠ¸ ê¸¸ì´:', prompt.length);
      console.log('í”„ë¡¬í”„íŠ¸ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ë§ˆì§€ë§‰ 1000ì):', prompt.substring(prompt.length - 1000));

      // ğŸ” ë””ë²„ê¹…: í”„ë¡¬í”„íŠ¸ì— ì‹¤ì œ ë‚´ìš©ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
      console.log('ğŸ” í”„ë¡¬í”„íŠ¸ í‚¤ì›Œë“œ ê²€ì‚¬:');
      console.log(`- "${projectName}" í¬í•¨:`, prompt.includes(projectName) ? 'âœ…' : 'âŒ');
      console.log('- "ì˜µì…˜" í¬í•¨:', prompt.includes('ì˜µì…˜') ? 'âœ…' : 'âŒ');
      console.log('- "ê¸°ëŠ¥" í¬í•¨:', prompt.includes('ê¸°ëŠ¥') ? 'âœ…' : 'âŒ');
      console.log('- ì´ë¯¸ì§€ ë¶„ì„ í¬í•¨:', imageAnalysis.length > 0 ? 'âœ…' : 'âŒ');

      // AI í˜¸ì¶œ
      console.log('Ollama API í˜¸ì¶œ ì‹œì‘');
      let generatedTestCases;
      try {
        generatedTestCases = await callOllama(prompt);
        console.log('AI í˜¸ì¶œ ì™„ë£Œ, ìƒì„±ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', generatedTestCases.length);
      } catch (error) {
        console.error('Ollama í˜¸ì¶œ ì‹¤íŒ¨, ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì‚¬ìš©:', error);
        // AI í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±
        generatedTestCases = generateDefaultTestCases(projectName, content);
      }

      // í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì‚¬ìš©
      if (!generatedTestCases || generatedTestCases.length === 0) {
        console.log('ìƒì„±ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ì—†ìŒ, ê¸°ë³¸ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì‚¬ìš©');
        generatedTestCases = generateDefaultTestCases(projectName, content);
      }

      // ì´ë¯¸ì§€ ë¶„ì„ì´ í¬í•¨ë˜ì—ˆì§€ë§Œ ì¼€ì´ìŠ¤ ìˆ˜ê°€ ì ìœ¼ë©´ ë³´ì™„ ìƒì„±
      if (imageFiles.length > 0 && generatedTestCases.length < 25) {
        console.log(`âš ï¸ ì´ë¯¸ì§€ ë¶„ì„ í¬í•¨ ì‹œ ì¼€ì´ìŠ¤ ìˆ˜ ë¶€ì¡± (${generatedTestCases.length}ê°œ)`);
        console.log('ì¶”ê°€ ì¼€ì´ìŠ¤ ìƒì„± ì‹œë„...');

        // thinking ê¸°ë°˜ ì¼€ì´ìŠ¤ ì¶”ê°€ ìƒì„±
        const additionalCases = createTestCasesFromThinking(`
        PDF ë‚´ìš©: ${content.substring(0, 1000)}
        ì´ë¯¸ì§€ ë¶„ì„: ${imageAnalysis}
        ê¸°ì¡´ ìƒì„±ëœ ì¼€ì´ìŠ¤ ìˆ˜: ${generatedTestCases.length}
        
        ì¶”ê°€ë¡œ ë” ë‹¤ì–‘í•œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë°œêµ´í•˜ì—¬ ì¼€ì´ìŠ¤ë¥¼ ë³´ê°•í•´ì•¼ í•¨.
      `, projectName);

        if (additionalCases.length > 0) {
          generatedTestCases = [...generatedTestCases, ...additionalCases];
          console.log(`âœ… ì¶”ê°€ ì¼€ì´ìŠ¤ ${additionalCases.length}ê°œ ìƒì„±, ì´ ${generatedTestCases.length}ê°œ`);
        }
      }

      console.log('ìµœì¢… í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', generatedTestCases.length);
      console.log('í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ë‚´ìš©:', JSON.stringify(generatedTestCases, null, 2));

      // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
      console.log('ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹œì‘');
      const db = new Database(dbPath);

      let generatedCount = 0;
      console.log('ì €ì¥í•  í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', generatedTestCases.length);

      for (const rawTestCase of generatedTestCases) {
        try {
          // í•œêµ­ì–´ í•„ë“œëª…ì„ ì˜ì–´ í•„ë“œëª…ìœ¼ë¡œ ë§¤í•‘
          const testCase = {
            title: rawTestCase.title || rawTestCase.ì‹œë‚˜ë¦¬ì˜¤ || rawTestCase['ì‹œë‚˜ë¦¬ì˜¤'] || 'ì œëª© ì—†ìŒ',
            description: rawTestCase.description || rawTestCase.ì„¤ëª… || rawTestCase['ì„¤ëª…'] || 'ì„¤ëª… ì—†ìŒ',
            category: rawTestCase.category || rawTestCase.ì¹´í…Œê³ ë¦¬ || rawTestCase['ì¹´í…Œê³ ë¦¬'] || 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸',
            priority: rawTestCase.priority || rawTestCase.ìš°ì„ ìˆœìœ„ || rawTestCase['ìš°ì„ ìˆœìœ„'] || 'medium',
            status: rawTestCase.status || rawTestCase.ìƒíƒœ || rawTestCase['ìƒíƒœ'] || 'draft',
            preCondition: rawTestCase.preCondition || rawTestCase.ì „ì œì¡°ê±´ || rawTestCase['ì „ì œì¡°ê±´'] || 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ ì¡°ê±´ í™•ì¸',
            testStep: rawTestCase.testStep || rawTestCase.ì…ë ¥ê°’ || rawTestCase['ì…ë ¥ê°’'] || '1. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì‹¤í–‰',
            expectedResult: rawTestCase.expectedResult || rawTestCase.ì˜ˆìƒê²°ê³¼ || rawTestCase['ì˜ˆìƒê²°ê³¼'] || 'ì˜ˆìƒ ê²°ê³¼ í™•ì¸',
            testStrategy: rawTestCase.testStrategy || rawTestCase.ê²€ì¦ë°©ë²• || rawTestCase['ê²€ì¦ë°©ë²•'] || 'ê¸°ëŠ¥ ê²€ì¦'
          };

          console.log('í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì €ì¥ ì‹œë„:', testCase.title);

          // description ìƒì„± (preCondition, testStep, expectedResult ëª¨ë‘ í¬í•¨)
          let description = testCase.description || '';
          if (testCase.preCondition || testCase.testStep || testCase.expectedResult) {
            description = `${testCase.description || ''}`;
            if (testCase.preCondition) {
              description += `\n\nì‚¬ì „ ì¡°ê±´:\n${testCase.preCondition}`;
            }
            if (testCase.testStep) {
              description += `\n\ní…ŒìŠ¤íŠ¸ ë‹¨ê³„:\n${testCase.testStep}`;
            }
            if (testCase.expectedResult) {
              description += `\n\nì˜ˆìƒ ê²°ê³¼:\n${testCase.expectedResult}`;
            }
          }

          // priorityì™€ status ê°’ì„ ì†Œë¬¸ìë¡œ ë³€í™˜
          const normalizedPriority = (testCase.priority || 'medium').toLowerCase();
          const normalizedStatus = (testCase.status || 'draft').toLowerCase();

          console.log('ì €ì¥í•  ë°ì´í„°:', {
            title: testCase.title || 'ì œëª© ì—†ìŒ',
            category: testCase.category || 'ê¸°ë³¸',
            priority: normalizedPriority,
            status: normalizedStatus,
            projectId: parseInt(projectId)
          });

          // ì¹´í…Œê³ ë¦¬ ID ì°¾ê¸° ë˜ëŠ” ìƒì„±
          let categoryId = 1; // ê¸°ë³¸ê°’
          try {
            // í”„ë¡œì íŠ¸ë³„ ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹Œ ì „ì—­ ì¹´í…Œê³ ë¦¬ ì‚¬ìš©
            const categoryStmt = db.prepare('SELECT id FROM test_categories WHERE name = ? LIMIT 1');
            const categoryResult = categoryStmt.get(testCase.category || 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸');

            if (categoryResult) {
              categoryId = categoryResult.id;
              console.log(`ì¹´í…Œê³ ë¦¬ ì°¾ìŒ: ${testCase.category} (ID: ${categoryId})`);
            } else {
              // ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
              console.log(`ì¹´í…Œê³ ë¦¬ '${testCase.category}' ì—†ìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.`);
              const insertCategoryStmt = db.prepare('INSERT INTO test_categories (name, project_id) VALUES (?, ?)');
              const insertResult = insertCategoryStmt.run(testCase.category || 'ê¸°ëŠ¥í…ŒìŠ¤íŠ¸', projectId);
              categoryId = insertResult.lastInsertRowid as number;
              console.log(`ìƒˆ ì¹´í…Œê³ ë¦¬ ìƒì„± ì™„ë£Œ: ${testCase.category} (ID: ${categoryId})`);
            }
          } catch (error) {
            console.log('ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
            categoryId = 1;
          }

          const stmt = db.prepare(`
          INSERT INTO test_cases (
            title, description, category_id, priority, status, project_id, 
            expected_result, created_by, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
        `);

          // Status ê°’ì„ DB í—ˆìš© ê°’ìœ¼ë¡œ ë§¤í•‘
          const statusMap: { [key: string]: string } = {
            'ready': 'draft',
            'pending': 'draft',
            'not started': 'draft',
            'active': 'active',
            'in progress': 'in_progress',
            'completed': 'passed',
            'done': 'passed',
            'failed': 'failed',
            'blocked': 'blocked',
            'skipped': 'skipped'
          };

          const rawStatus = (testCase.status || 'draft').toLowerCase();
          const dbStatus = statusMap[rawStatus] || 'draft';

          // Priority ê°’ì„ DB í—ˆìš© ê°’ìœ¼ë¡œ ë§¤í•‘
          const priorityMap: { [key: string]: string } = {
            'ìƒ': 'high',
            'ë†’ìŒ': 'high',
            'high': 'high',
            'ì¤‘': 'medium',
            'ë³´í†µ': 'medium',
            'medium': 'medium',
            'í•˜': 'low',
            'ë‚®ìŒ': 'low',
            'low': 'low',
            'ê¸´ê¸‰': 'critical',
            'critical': 'critical'
          };

          const rawPriority = (testCase.priority || 'medium').toLowerCase();
          const dbPriority = priorityMap[rawPriority] || 'medium';

          const result = stmt.run(
            testCase.title || 'ì œëª© ì—†ìŒ',
            description,
            categoryId,
            dbPriority,
            dbStatus,
            parseInt(projectId),
            testCase.expectedResult || '',
            1  // created_by (admin user)
          );

          console.log('SQL ì‹¤í–‰ ê²°ê³¼:', result);

          // í…ŒìŠ¤íŠ¸ ìŠ¤í… ì €ì¥ (testStepì´ ìˆëŠ” ê²½ìš°)
          if (testCase.testStep && result.lastInsertRowid) {
            const testCaseId = result.lastInsertRowid;
            const steps = testCase.testStep.split('\n').filter(step => step.trim());

            for (let i = 0; i < steps.length; i++) {
              const step = steps[i].trim();
              if (step) {
                try {
                  const stepStmt = db.prepare(`
                  INSERT INTO test_steps (test_case_id, step_number, action, expected_result)
                  VALUES (?, ?, ?, ?)
                `);

                  stepStmt.run(
                    testCaseId,
                    i + 1,
                    step,
                    '' // ê°œë³„ ìŠ¤í…ì˜ ì˜ˆìƒ ê²°ê³¼ëŠ” ë¹„ì›Œë‘ 
                  );
                } catch (stepError) {
                  console.error('í…ŒìŠ¤íŠ¸ ìŠ¤í… ì €ì¥ ì˜¤ë¥˜:', stepError);
                }
              }
            }
            console.log('í…ŒìŠ¤íŠ¸ ìŠ¤í… ì €ì¥ ì™„ë£Œ:', steps.length, 'ê°œ');
          }

          generatedCount++;
          console.log('í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì €ì¥ ì™„ë£Œ:', testCase.title);
        } catch (error) {
          console.error('í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì €ì¥ ì˜¤ë¥˜:', error);
          console.error('ì˜¤ë¥˜ ë°œìƒí•œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤:', testCase);
        }
      }

      console.log('ì´ ì €ì¥ëœ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìˆ˜:', generatedCount);

      // ì„ì‹œ íŒŒì¼ ì‚­ì œ
      try {
        fs.unlinkSync(filePath);
      } catch (error) {
        console.error('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
      }

      return NextResponse.json({
        success: true,
        generatedCount,
        message: `${generatedCount}ê°œì˜ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
      });

    } catch (error) {
      console.error('AI í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± ì˜¤ë¥˜:', error);

      // ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‹œë„
      try {
        if (typeof filePath !== 'undefined') {
          fs.unlinkSync(filePath);
          console.log('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        }
      } catch (deleteError) {
        console.error('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', deleteError);
      }

      return NextResponse.json(
        {
          success: false,
          error: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          details: process.env.NODE_ENV === 'development' ? error : undefined
        },
        { status: 500 }
      );
    }
  }
